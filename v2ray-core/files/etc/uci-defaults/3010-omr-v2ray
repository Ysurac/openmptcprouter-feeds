#!/bin/sh

if [ -z "$(uci -q get v2ray.main2)" ]; then
	touch /etc/config/v2ray
	uci batch <<-EOF
		set v2ray.main=v2ray
		set v2ray.main.v2ray_file='/usr/bin/v2ray'
		set v2ray.main.mem_percentage='0'
		set v2ray.main.loglevel='warning'
		set v2ray.main.access_log='/dev/null'
		set v2ray.main.error_log='/var/log/v2ray-error.log'
		set v2ray.main.enabled='0'
		set v2ray.main.outbounds='omrout'
		set v2ray.main.inbounds='omr'
		add_list v2ray.main.inbounds='omrtest'
		set v2ray.main_dns=dns
		set v2ray.main_dns.hosts='example.com|127.0.0.1'
		set v2ray.main_dns.enabled='0'
		set v2ray.main_routing=routing
		set v2ray.main_routing.domain_strategy='IPOnDemand'
		set v2ray.main_policy=policy
		set v2ray.main_policy.enabled='1'
		set v2ray.main_policy.levels='policy_level_0'
		set v2ray.policy_level_0=policy_level
		set v2ray.policy_level_0.level='0'
		set v2ray.policy_level_0.handshake='4'
		set v2ray.policy_level_0.conn_idle='600'
		set v2ray.policy_level_0.uplink_only='0'
		set v2ray.policy_level_0.downlink_only='0'
		set v2ray.policy_level_0.buffer_size='512'
		set v2ray.main_reverse=reverse
		set v2ray.main_reverse.enabled='0'
		set v2ray.main_reverse.bridges='bridge|test.v2ray.com'
		set v2ray.main_reverse.portals='portal|test.v2ray.com'
		set v2ray.main_transparent_proxy=transparent_proxy
		set v2ray.main_transparent_proxy.proxy_mode='default'
		set v2ray.main_transparent_proxy.apnic_delegated_mirror='apnic'
		set v2ray.main_transparent_proxy.gfwlist_mirror='github'
		set v2ray.main_transparent_proxy.redirect_udp='1'
		set v2ray.main_transparent_proxy.redirect_port='1897'
		set v2ray.omrout=outbound
		set v2ray.omrout.alias='out'
		set v2ray.omrout.protocol='vless'
		set v2ray.omrout.s_vmess_address=''
		set v2ray.omrout.s_vmess_port='65228'
		set v2ray.omrout.s_vmess_user_id=''
		set v2ray.omrout.s_vmess_user_security='none'
		set v2ray.omrout.s_vmess_user_alter_id='0'
		set v2ray.omrout.s_vless_address=''
		set v2ray.omrout.s_vless_port='65228'
		set v2ray.omrout.s_vless_user_id=''
		set v2ray.omrout.s_vless_user_security='none'
		set v2ray.omrout.s_vless_user_encryption='none'
		set v2ray.omrout.s_vless_user_alter_id='0'
		set v2ray.omrout.ss_network='tcp'
		set v2ray.omrout.ss_security='tls'
		set v2ray.omrout.ss_tls_allow_insecure='1'
		set v2ray.omrout.ss_tls_disable_system_root='1'
		set v2ray.omrout.ss_tls_cert_usage='verify'
		set v2ray.omrout.ss_tls_cert_file='/etc/luci-uploads/client.crt'
		set v2ray.omrout.ss_tls_key_file='/etc/luci-uploads/client.key'
		set v2ray.omrout.mux_concurrency='8'
		set v2ray.omr=inbound
		set v2ray.omr.alias='V2RayServer'
		set v2ray.omr.listen='::'
		set v2ray.omr.port='1897'
		set v2ray.omr.protocol='dokodemo-door'
		set v2ray.omr.s_dokodemo_door_network='tcp'
		add_list v2ray.omr.s_dokodemo_door_network='udp'
		set v2ray.omr.ss_sockopt_tproxy='redirect'
		set v2ray.omr.ss_sockopt_tcp_fast_open='1'
		set v2ray.omr.s_dokodemo_door_follow_redirect='1'
		set v2ray.omrtest=inbound
		set v2ray.omrtest.port='1111'
		set v2ray.omrtest.protocol='socks'
		set v2ray.omrtest.listen='127.0.0.1'
		set v2ray.omrtest.s_socks_auth='noauth'
		set v2ray.omrtest.s_socks_udp='1'
		set v2ray.omrtest.s_socks_ip='127.0.0.1'
		set v2ray.omrtest.s_socks_userlevel='0
		commit v2ray
	EOF
fi

exit 0